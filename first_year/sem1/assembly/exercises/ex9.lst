     1                                  bits 32 ; assembling for the 32 bits architecture
     2                                  
     3                                  ; declare the EntryPoint (a label defining the very first instruction of the program)
     4                                  global start        
     5                                  
     6                                  ; declare external functions needed by our program
     7                                  extern exit, fopen, fclose, fprintf, fread             ; tell nasm that exit exists even if we won't be defining it
     8                                  import exit msvcrt.dll    ; exit is a function that ends the calling process. It is defined in msvcrt.dll
     9                                                            ; msvcrt.dll contains exit, printf and all the other important C-runtime specific functions
    10                                  import fopen msvcrt.dll
    11                                  import fclose msvcrt.dll
    12                                  import fprintf msvcrt.dll
    13                                  import fread msvcrt.dll
    14                                  
    15                                  ; our data is declared here (the variables needed by our program)
    16                                  segment data use32 class=data
    17                                      len equ 100
    18 00000000 00<rept>                    text times len db 0
    19 00000064 5468652066696E616C-         out_messae db "The final sum is: %d", 0
    19 0000006D 2073756D2069733A20-
    19 00000076 256400             
    20 00000079 7200                        access_mode1 db "r", 0
    21 0000007B 7700                        access_mode2 db "w", 0
    22 0000007D 6578395F696E2E7478-         file_name_in db "ex9_in.txt", 0
    22 00000086 7400               
    23 00000088 6578395F6F75742E74-         file_name_out db "ex9_out.txt", 0
    23 00000091 787400             
    24 00000094 FFFFFFFF                    file_descriptor dd -1
    25                                  
    26                                  ; our code starts here
    27                                  segment code use32 class=code
    28                                      start:
    29 00000000 68[79000000]                    push dword access_mode1
    30 00000005 68[7D000000]                    push dword file_name_in
    31 0000000A FF15[00000000]                  call [fopen]
    32 00000010 83C408                          add esp, 4 * 2
    33                                          
    34 00000013 A3[94000000]                    mov [file_descriptor], eax
    35 00000018 83F800                          cmp eax, 0
    36 0000001B 7437                            je final1
    37                                          
    38 0000001D FF35[94000000]                  push dword [file_descriptor]
    39 00000023 6A64                            push dword len
    40 00000025 6A01                            push dword 1
    41 00000027 68[00000000]                    push dword text
    42 0000002C FF15[00000000]                  call [fread]
    43 00000032 83C410                          add esp, 4 * 4
    44                                          
    45 00000035 BE[00000000]                    mov esi, text
    46 0000003A 31DB                            xor ebx, ebx
    47 0000003C 31C0                            xor eax, eax
    48                                          
    49 0000003E FC                              cld
    50                                          add_digits:
    51 0000003F AC                                  lodsb
    52 00000040 3C00                                cmp al, 0
    53 00000042 7410                                je final1
    54                                              
    55 00000044 3C30                                cmp al, "0"
    56 00000046 720A                                jb skip
    57                                              
    58 00000048 3C39                                cmp al, "9"
    59 0000004A 7706                                ja skip
    60                                              
    61 0000004C 2C30                                sub al, "0"
    62 0000004E 01C3                                add ebx, eax
    63 00000050 EBED                            jmp add_digits
    64                                          
    65                                          skip:
    66 00000052 EBEB                                jmp add_digits
    67                                          
    68                                          final1:
    69 00000054 FF35[94000000]                  push dword [file_descriptor]
    70 0000005A FF15[00000000]                  call [fclose]
    71 00000060 83C404                          add esp, 4
    72                                          
    73 00000063 68[7B000000]                    push dword access_mode2
    74 00000068 68[88000000]                    push dword file_name_out
    75 0000006D FF15[00000000]                  call [fopen]
    76 00000073 83C408                          add esp, 4 * 2
    77                                          
    78 00000076 A3[94000000]                    mov [file_descriptor], eax
    79 0000007B 83F800                          cmp eax, 0
    80 0000007E 7415                            je final2
    81                                          
    82 00000080 53                              push dword ebx
    83 00000081 68[64000000]                    push dword out_messae
    84 00000086 FF35[94000000]                  push dword [file_descriptor]
    85 0000008C FF15[00000000]                  call [fprintf]
    86 00000092 83C40C                          add esp, 4 * 3
    87                                          
    88                                          final2:
    89 00000095 FF35[94000000]                  push dword [file_descriptor]
    90 0000009B FF15[00000000]                  call [fclose]
    91 000000A1 83C404                          add esp, 4
    92                                          
    93                                          ; exit(0)
    94 000000A4 6A00                            push    dword 0      ; push the parameter for exit onto the stack
    95 000000A6 FF15[00000000]                  call    [exit]       ; call exit to terminate the program
